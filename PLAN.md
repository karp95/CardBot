# План реализации Telegram-бота для изучения английских слов

## Текущий статус (что сделано / что осталось)

**Выполнено:** блоки 1–7 (инфраструктура, БД, сервисы, бот, список, статистика, напоминания).

**Осталось:** блок 8 (деплой).

---

## Осталось сделать (фиксируем, не делаем пока)

> Пока не скажешь «делай» — только фиксируем идеи и предлагаем изменения.

### Блок 8: Деплой
- [ ] 8.1 — Docker Compose для PostgreSQL
- [ ] 8.2 — Инструкция по локальному запуску *(частично в INSTRUCTIONS.md)*
- [ ] 8.3 — Health-check endpoint (Spring Boot Actuator)
- [ ] 8.4 — Документация по деплою в облако (Heroku, Railway, AWS, VPS)

### Предлагаемые изменения (по твоим мыслям)

#### 1. Панель кнопок с командами при старте — ✅ СДЕЛАНО
- ReplyKeyboardMarkup при /start с кнопками: Добавить, Учить, Список, Статистика, Наборы, Помощь
- Кнопки маппятся на команды (mapButtonToCommand)

#### 2. Приветствие с именем пользователя — ✅ СДЕЛАНО
- «Привет, {имя}!» — используется getFirstName() или getUserName()

#### 3. Наборы карточек (темы/коллекции) — ✅ СДЕЛАНО
- Сущность CardSet, миграции V5, V6
- `/add набор: слово + перевод` — добавление в набор
- `/sets` — список наборов, создание, удаление
- `/learn` — выбор набора для изучения
- `/list` — просмотр карточек набора (из /sets)

---

### Режимы обучения — план внедрения

#### Режим 1: Обратное направление (RU → EN) — простой
**Суть:** показывать перевод, угадывать слово на английском.

| Шаг | Задача |
|-----|--------|
| 1.1 | Добавить enum `LearnDirection` (EN_RU, RU_EN) |
| 1.2 | При выборе набора показывать кнопки «EN → RU» / «RU → EN» |
| 1.3 | Сохранять направление в `learningDirection` (Map userId → direction) |
| 1.4 | В `sendCardForLearning`: если RU_EN — показывать translation, при SHOW показывать word |
| 1.5 | Обновить `editToTranslation` и callback NEXT для учёта направления |

---

#### Режим 2: Случайный / по порядку — простой
**Суть:** выбор порядка карточек — случайно или последовательно.

| Шаг | Задача |
|-----|--------|
| 2.1 | Добавить enum `LearnOrder` (RANDOM, SEQUENTIAL) |
| 2.2 | При выборе набора добавить кнопки «Случайно» / «По порядку» |
| 2.3 | CardRepository: `findByUserIdOrderByCreatedAt` для sequential |
| 2.4 | LearningService: хранить `currentIndex` для sequential, при NEXT — следующий по индексу |
| 2.5 | При RANDOM — оставить текущую логику `findRandomByUserId` |

---

#### Режим 3: Только новые / только повторение — средний
**Суть:** фильтр — «новые» (не показывались сегодня) или «повторение» (уже видели).

| Шаг | Задача |
|-----|--------|
| 3.1 | Миграция: таблица `card_views` (user_id, card_id, viewed_at) или поле в LearningStats |
| 3.2 | При показе карточки — записывать в card_views |
| 3.3 | CardRepository: `findByUserIdNotViewedToday` / `findByUserIdViewedToday` |
| 3.4 | При выборе набора добавить кнопки «Новые» / «Повторение» / «Все» |
| 3.5 | LearningService: методы getNextNewCard / getNextReviewCard |

---

#### Режим 4: «Своё слово» (ввод перевода) — средний
**Суть:** показать слово → пользователь вводит перевод → проверка.

| Шаг | Задача |
|-----|--------|
| 4.1 | UserState: добавить `TYPE_LEARN_INPUT` (cardId, ожидание ввода) |
| 4.2 | При выборе режима — кнопка «Своё слово» |
| 4.3 | Показывать слово, кнопка «Проверить» — переходим в состояние ожидания ввода |
| 4.4 | Обработка текста: сравнение с translation (trim, ignore case, допуск опечаток?) |
| 4.5 | Ответ: «Верно» / «Неверно. Правильно: …» + кнопки Следующая / Закончить |

---

#### Режим 5: Выбор из вариантов (квиз) — средний
**Суть:** показать слово → 4 варианта перевода (1 верный + 3 случайных) → выбор.

| Шаг | Задача |
|-----|--------|
| 5.1 | LearningService: при выборе карточки — подобрать 3 случайных перевода из других карточек |
| 5.2 | Перемешать 4 варианта (random shuffle) |
| 5.3 | Callback: QUIZ_ANSWER:cardId:answerIndex |
| 5.4 | При ответе: «Верно» / «Неверно. Правильно: …» + кнопки Следующая / Закончить |
| 5.5 | Учесть направление (EN→RU или RU→EN) для вариантов |

---

#### Режим 6: Оценка сложности (Легко / Нормально / Сложно) — средний
**Суть:** после показа карточки — кнопки «Легко» / «Нормально» / «Сложно» влияют на частоту показов.

| Шаг | Задача |
|-----|--------|
| 6.1 | Миграция: в cards или отдельная таблица — difficulty, lastShownAt, interval |
| 6.2 | После показа перевода — кнопки «Легко» / «Нормально» / «Сложно» вместо «Следующая» |
| 6.3 | Callback: RATE:cardId:EASY|NORMAL|HARD |
| 6.4 | Обновлять lastShownAt, interval (упрощённо: EASY — реже, HARD — чаще) |
| 6.5 | getNextCard: приоритет карточкам с HARD или давно не показывавшимся |

---

#### Режим 7: Интервальное повторение (Spaced Repetition) — сложный
**Суть:** алгоритм SM-2 — показ карточек по расписанию по качеству ответа.

| Шаг | Задача |
|-----|--------|
| 7.1 | Миграция: card_reviews (card_id, user_id, ease_factor, interval, next_review_at) |
| 7.2 | Реализовать SM-2: при ответе (0–5) обновлять interval, next_review_at |
| 7.3 | getNextCard: выбирать карточки с next_review_at <= now или новые |
| 7.4 | Интеграция с режимом «Своё слово» или «Оценка» — оценка 0–5 |

---

#### Режим 8: Цель на сессию — простой
**Суть:** «Повторить 10 карточек» — сессия заканчивается после 10.

| Шаг | Задача |
|-----|--------|
| 8.1 | При выборе набора — кнопка «Цель: 10 карточек» или ввод числа |
| 8.2 | Сохранять: `sessionGoal` (Map userId → count) |
| 8.3 | Счётчик: при каждой карточке — increment, при достижении цели — «Сессия завершена!» |
| 8.4 | Кнопка «Закончить» — досрочное завершение |

---

#### Порядок внедрения (рекомендуемый)
1. **Режим 1** (RU → EN) — быстро, сразу даёт новый опыт  
2. **Режим 2** (Случайно / по порядку) — просто  
3. **Режим 8** (Цель на сессию) — мотивация  
4. **Режим 4** (Своё слово) — полезно для запоминания  
5. **Режим 5** (Квиз) — удобно в Telegram  

---

## Сводка требований

| Параметр | Решение |
|----------|---------|
| Стек | Java, Spring Boot, PostgreSQL |
| Пользователи | У каждого свой набор карточек, синхронизация между устройствами |
| Карточки | Слово, перевод, транскрипция (опционально). Редактирование и удаление — да |
| Импорт/экспорт | Нет |
| Обучение | Случайный показ. Слово → кнопка → перевод |
| Статистика | Да |
| Команды | /start, /add, /learn, /stats, /list, /help |
| Inline-кнопки | Да |
| Напоминания | Раз в день |
| Конфигурация | Переменные окружения + .env для разработки |
| Деплой | Сначала локально, затем облако |

---

## Этап 1: Инфраструктура и базовая настройка

### 1.1 Инициализация проекта
- [ ] Создать Spring Boot проект (Maven/Gradle)
- [ ] Добавить зависимости:
  - `spring-boot-starter-data-jpa`
  - `spring-boot-starter-web`
  - `postgresql`
  - `telegrambots-spring-boot-starter` (или `telegrambots`)
  - `flyway` (миграции БД)
  - `lombok`
- [ ] Настроить `application.yml` с чтением из env-переменных
- [ ] Создать `.env.example` с перечнем переменных
- [ ] Добавить `.env` в `.gitignore`

### 1.2 База данных
- [ ] Настроить подключение к PostgreSQL
- [ ] Создать Flyway-миграции для таблиц:
  - `users` (telegram_id, username, created_at)
  - `cards` (id, user_id, word, translation, transcription, created_at, updated_at)
  - `learning_stats` (user_id, cards_viewed, last_reminder_at и т.д.)

### 1.3 Конфигурация
- [ ] Класс конфигурации для Telegram Bot API (токен из env)
- [ ] Настройка для локального запуска PostgreSQL (Docker Compose опционально)

---

## Этап 2: Модели и репозитории

### 2.1 Сущности JPA
- [ ] `User` — telegramId, username, createdAt
- [ ] `Card` — word, translation, transcription, user
- [ ] `LearningStats` — статистика по пользователю

### 2.2 Репозитории
- [ ] `UserRepository` — findByTelegramId
- [ ] `CardRepository` — findByUserId, countByUserId
- [ ] `LearningStatsRepository` — findByUserId

---

## Этап 3: Сервисный слой

### 3.1 UserService
- [ ] Регистрация/получение пользователя по telegramId
- [ ] Создание пользователя при первом /start

### 3.2 CardService
- [ ] Создание карточки (word, translation, transcription?)
- [ ] Редактирование карточки
- [ ] Удаление карточки
- [ ] Получение списка карточек пользователя (с пагинацией для /list)
- [ ] Получение случайной карточки для обучения

### 3.3 LearningService
- [ ] Запуск сессии обучения
- [ ] Получение следующей случайной карточки
- [ ] Обновление статистики (cards_viewed)

### 3.4 StatsService
- [ ] Подсчёт: всего карточек, просмотренных за сессию, за всё время
- [ ] Формирование текста для /stats

### 3.5 ReminderService
- [ ] Планировщик (Scheduled) — раз в день проверять пользователей
- [ ] Отправка напоминаний тем, кто не учился сегодня (или по настраиваемому времени)

---

## Этап 4: Telegram Bot

### 4.1 Обработчики команд
- [ ] `/start` — приветствие, регистрация, краткая инструкция
- [ ] `/add` — добавление карточки одной строкой через `+`: `слово + перевод + транскрипция` (транскрипция опциональна)
- [ ] `/learn` — запуск сессии, показ первой карточки с кнопками
- [ ] `/list` — список карточек с кнопками выбора (редактировать/удалить)
- [ ] `/stats` — вывод статистики
- [ ] `/help` — справка по командам

### 4.2 Обработчики callback (inline-кнопки)
- [ ] `SHOW_TRANSLATION:{cardId}` — показать перевод карточки
- [ ] `NEXT_CARD` — следующая карточка
- [ ] `END_SESSION` — закончить сессию
- [ ] `EDIT_CARD:{cardId}` — редактировать карточку
- [ ] `DELETE_CARD:{cardId}` — удалить карточку (с подтверждением)
- [ ] `LIST_PAGE:{page}` — пагинация списка карточек

### 4.3 Диалоги (состояния)
- [ ] Состояния нужны только для редактирования карточек (пошаговое изменение полей)
- [ ] Хранение состояния пользователя (in-memory Map или Redis для масштабирования)

### 4.4 Форматирование сообщений
- [ ] Карточка в режиме обучения: **слово** [Показать перевод] [Следующая] [Закончить]
- [ ] Карточка с переводом: **слово** — яблоко (только перевод, без транскрипции) [Следующая] [Закончить]
- [ ] Список карточек: компактный вывод с кнопками

---

## Этап 5: Напоминания

### 5.1 Scheduler
- [ ] `@Scheduled(cron = "0 0 10 * * ?")` — например, в 10:00 каждый день
- [ ] Выбор пользователей, которым отправить напоминание (не учились сегодня / не отписались)
- [ ] Отправка сообщения с кнопкой «Учить» → /learn

### 5.2 Настройки напоминаний (опционально на будущее)
- [ ] Время напоминания (пока можно захардкодить 10:00)
- [ ] Возможность отключить напоминания

---

## Этап 6: Тестирование и деплой

### 6.1 Локальный запуск
- [ ] Docker Compose для PostgreSQL (опционально)
- [ ] Инструкция по запуску: `./mvnw spring-boot:run` с переменными из .env
- [ ] Создать бота через @BotFather, получить токен

### 6.2 Подготовка к облаку
- [ ] Вынести все секреты в переменные окружения
- [ ] Настроить health-check endpoint
- [ ] Документация по деплою (Heroku, Railway, AWS, VPS — по выбору)

---

## Структура проекта (предлагаемая)

```
CardBot/
├── src/main/java/com/cardbot/
│   ├── CardBotApplication.java
│   ├── config/
│   │   ├── BotConfig.java
│   │   └── TelegramBotConfig.java
│   ├── model/
│   │   ├── User.java
│   │   ├── Card.java
│   │   └── LearningStats.java
│   ├── repository/
│   │   ├── UserRepository.java
│   │   ├── CardRepository.java
│   │   └── LearningStatsRepository.java
│   ├── service/
│   │   ├── UserService.java
│   │   ├── CardService.java
│   │   ├── LearningService.java
│   │   ├── StatsService.java
│   │   └── ReminderService.java
│   ├── bot/
│   │   ├── CardBot.java (extends TelegramLongPollingBot)
│   │   ├── handlers/
│   │   │   ├── CommandHandler.java
│   │   │   └── CallbackHandler.java
│   │   └── state/
│   │       └── UserState.java (FSM)
│   └── dto/
│       └── ...
├── src/main/resources/
│   ├── application.yml
│   └── db/migration/
│       ├── V1__create_users.sql
│       ├── V2__create_cards.sql
│       └── V3__create_learning_stats.sql
├── .env.example
├── docker-compose.yml (опционально)
└── pom.xml / build.gradle
```

---

## Задачи по приоритетам (от простого к сложному)

### Легенда приоритетов
| Приоритет | Значение |
|-----------|----------|
| **P0** | Критично — без этого бот не запустится |
| **P1** | Высокий — основной функционал MVP |
| **P2** | Средний — важно, но после MVP |
| **P3** | Низкий — улучшения |

---

### Блок 1: Инфраструктура (P0)

| # | Задача | Сложность | Зависимости |
|---|--------|-----------|-------------|
| 1.1 | Создать Spring Boot проект (Maven) | ●○○ | — |
| 1.2 | Добавить зависимости в pom.xml | ●○○ | 1.1 |
| 1.3 | Настроить application.yml (чтение из env) | ●○○ | 1.1 |
| 1.4 | Создать .env.example | ○○○ | — |
| 1.5 | Добавить .env в .gitignore | ○○○ | — |
| 1.6 | Создать CardBotApplication.java | ○○○ | 1.1 |

---

### Блок 2: База данных (P0)

| # | Задача | Сложность | Зависимости |
|---|--------|-----------|-------------|
| 2.1 | Flyway: V1__create_users.sql | ●○○ | 1.2 |
| 2.2 | Flyway: V2__create_cards.sql | ●○○ | 2.1 |
| 2.3 | Flyway: V3__create_learning_stats.sql | ●○○ | 2.2 |
| 2.4 | Сущность User | ●○○ | 2.1 |
| 2.5 | Сущность Card | ●○○ | 2.2 |
| 2.6 | Сущность LearningStats | ●○○ | 2.3 |
| 2.7 | UserRepository | ○○○ | 2.4 |
| 2.8 | CardRepository (+ метод random) | ●○○ | 2.5 |
| 2.9 | LearningStatsRepository | ○○○ | 2.6 |

---

### Блок 3: Сервисы (P0–P1)

| # | Задача | Сложность | Зависимости |
|---|--------|-----------|-------------|
| 3.1 | UserService: getOrCreate | ●○○ | 2.7 |
| 3.2 | CardService: create, parse строки через + | ●●○ | 2.8 |
| 3.3 | CardService: update, delete, findAllByUser | ●○○ | 3.2 |
| 3.4 | CardService: getRandomCard | ●○○ | 2.8 |
| 3.5 | LearningService: getNextCard, updateStats | ●○○ | 3.4, 2.9 |
| 3.6 | StatsService: getStats | ●○○ | 2.8, 2.9 |

---

### Блок 4: Telegram Bot — базовый (P0–P1)

| # | Задача | Сложность | Зависимости |
|---|--------|-----------|-------------|
| 4.1 | BotConfig: токен из env | ●○○ | 1.3 |
| 4.2 | Класс бота, регистрация в Spring | ●●○ | 4.1 |
| 4.3 | Обработчик /start | ●○○ | 4.2, 3.1 |
| 4.4 | Обработчик /add (парсинг, валидация) | ●●○ | 4.2, 3.2 |
| 4.5 | Обработчик /learn: показ карточки | ●●○ | 4.2, 3.5 |
| 4.6 | Callback: SHOW_TRANSLATION | ●○○ | 4.5 |
| 4.7 | Callback: NEXT_CARD | ●○○ | 4.5 |
| 4.8 | Callback: END_SESSION | ●○○ | 4.5 |

---

### Блок 5: Список и управление карточками (P1)

| # | Задача | Сложность | Зависимости |
|---|--------|-----------|-------------|
| 5.1 | Обработчик /list с пагинацией | ●●○ | 4.2, 3.3 |
| 5.2 | Callback: EDIT_CARD + диалог редактирования | ●●● | 5.1, 3.3 |
| 5.3 | Callback: DELETE_CARD + подтверждение | ●●○ | 5.1, 3.3 |
| 5.4 | Хранение состояния пользователя (Map) для edit | ●●○ | 5.2 |

---

### Блок 6: Статистика и справка (P1)

| # | Задача | Сложность | Зависимости |
|---|--------|-----------|-------------|
| 6.1 | Обработчик /stats | ●○○ | 4.2, 3.6 |
| 6.2 | Обработчик /help | ○○○ | 4.2 |

---

### Блок 7: Напоминания (P2)

| # | Задача | Сложность | Зависимости |
|---|--------|-----------|-------------|
| 7.1 | ReminderService: @Scheduled | ●●○ | 4.2, 2.9 |
| 7.2 | Логика: кому отправить напоминание | ●●○ | 7.1 |
| 7.3 | Отправка сообщения с кнопкой «Учить» | ●○○ | 7.2 |

---

### Блок 8: Деплой (P2–P3)

| # | Задача | Сложность | Зависимости |
|---|--------|-----------|-------------|
| 8.1 | Docker Compose для PostgreSQL | ●○○ | — |
| 8.2 | Инструкция по локальному запуску | ○○○ | — |
| 8.3 | Health-check endpoint | ●○○ | — |
| 8.4 | Документация по деплою в облако | ●○○ | — |

---

### Порядок выполнения (рекомендуемый)

```
1.1 → 1.2 → 1.3 → 1.4 → 1.5 → 1.6
         ↓
2.1 → 2.2 → 2.3 → 2.4 → 2.5 → 2.6 → 2.7 → 2.8 → 2.9
         ↓
3.1 → 3.2 → 3.3 → 3.4 → 3.5 → 3.6
         ↓
4.1 → 4.2 → 4.3 → 4.4 → 4.5 → 4.6 → 4.7 → 4.8   ← MVP готов
         ↓
5.1 → 5.2 → 5.3 → 5.4
         ↓
6.1 → 6.2
         ↓
7.1 → 7.2 → 7.3
         ↓
8.1 → 8.2 → 8.3 → 8.4
```

---

### MVP (минимально работающий бот)

Задачи **1.1–4.8** — после них бот умеет:
- Регистрировать пользователей
- Добавлять карточки
- Учить слова (показ → перевод → следующая)

---

### Полный функционал

Задачи **5.1–6.2** — список, редактирование, удаление, статистика, справка.

---

### С напоминаниями и деплоем

Задачи **7.1–8.4**.

---

## Зависимости (Maven)

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
    </dependency>
    <dependency>
        <groupId>org.telegram</groupId>
        <artifactId>telegrambots-spring-boot-starter</artifactId>
        <version>6.9.7.1</version>
    </dependency>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-core</artifactId>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

---

## Уточнённые решения

- **Формат `/add`**: одна строка с разделителем `+`. Пример: `apple + яблоко` или `apple + яблоко + ˈæpl`
- **Обязательные поля**: только слово и перевод. Транскрипция — опционально
- **Теги**: не используются
- **Язык интерфейса**: русский
- **Режим обучения**: после «Показать перевод» показывать только перевод (без транскрипции)
